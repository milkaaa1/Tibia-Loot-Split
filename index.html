<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tibia Loot Split ‚Äî Multi-Session</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1520; --muted:#a9b1bb; --text:#e6edf3; --accent:#38bdf8; --good:#22c55e; --bad:#ef4444; --warn:#f59e0b; --border:#243042;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    h1{font-weight:700;margin:16px 0 8px;font-size:20px}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    textarea{width:100%;min-height:220px;background:#0b1220;border:1px solid var(--border);border-radius:12px;color:var(--text);padding:12px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > *{flex:1}
    button{background:linear-gradient(180deg,#1e293b,#0b1220);border:1px solid var(--border);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    button:hover{border-color:#3b82f6}
    .btn-accent{background:linear-gradient(180deg,#06b6d4,#0284c7);border-color:transparent}
    .btn-ghost{background:transparent;border:1px dashed var(--border)}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:10px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#0b1220;color:var(--muted);font-size:12px}
    table{width:100%;border-collapse:collapse;background:#0b1220;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:right}
    th:first-child, td:first-child{text-align:left}
    thead th{position:sticky;top:0;background:#0d1422;z-index:1}
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    .warn{color:var(--warn)}
    .notice{padding:10px 12px;border-left:4px solid var(--warn);background:#1a1420;border-radius:10px}
    .footer{opacity:.7;margin-top:18px}
    .small{font-size:12px}
    .right{float:right}
    .nowrap{white-space:nowrap}
    .spacer{height:8px}
    .hl{background:rgba(56,189,248,.1);padding:2px 6px;border:1px solid rgba(56,189,248,.25);border-radius:8px}
    .copybtn{padding:4px 8px;border-radius:8px;border:1px solid var(--border);background:#0b1220;cursor:pointer}
    .copybtn:hover{border-color:#3b82f6}
    .tx-amount{font-weight:600}
  </style>
</head>
<body>
  <div class="container">
    <h1>üó°Ô∏è Tibia Loot Split ‚Äî Multi-Session</h1>
    <div class="muted">Paste one or more Hunt Analyzer blocks. I will split each session fairly among participants in that session, then consolidate transfers across sessions.</div>
    <div class="spacer"></div>

    <div class="card">
      <div class="toolbar">
        <button id="analyze" class="btn-accent">Analyze</button>
        <button id="clear" class="btn-ghost">Clear</button>
        <span class="pill">Version 1.2</span>
      </div>
      <div class="spacer"></div>
      <textarea id="paste" placeholder="Paste multiple sessions here..."></textarea>
    </div>

    <div id="output" class="grid" style="margin-top:12px; gap:12px"></div>

    <div class="footer small muted">
      Settlement is computed <b>per session</b> (only among players present), then <b>consolidated</b> so each payer‚Üíreceiver pair appears once across all sessions.
    </div>
  </div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const by = (k,dir=1) => (a,b)=> a[k]===b[k]?0: (a[k]>b[k]?dir:-dir);
  const num = s => {
    if(s==null) return 0;
    const m = (s+"").replace(/[^0-9\-]/g, "");
    if(!m || m === "-") return 0;
    return parseInt(m,10);
  };
  const fmt = n => Number(n||0).toLocaleString("en-US");
  const fmtPlain = n => String(Math.round(n||0)); // for "Transfer 300000 to X"
  const durToHours = hstr => {
    if(!hstr) return 0;
    const m = (hstr+"").match(/(\d{1,2}):(\d{2})/);
    if(!m) return 0;
    const hh = parseInt(m[1],10)||0; const mm = parseInt(m[2],10)||0;
    return hh + mm/60;
  };

  function splitSessions(raw){
    const blocks = [];
    const regex = /Session data:[\s\S]*?(?=\n\s*Session data:|\u0000|$)/g;
    let match;
    while((match = regex.exec(raw))){
      blocks.push(match[0].trim());
    }
    return blocks;
  }

  function parseSession(text, index){
    const lines = text.split(/\r?\n/).map(l=>l.replace(/\t/g,"  "));
    const session = { index, from:null, to:null, durationHours:0, lootType:null, group:{loot:0,supplies:0,balance:0}, players:[], warnings:[], tx:[] };

    const mDates = text.match(/Session data:\s*From\s*(.*?)\s*to\s*(.*)/i);
    if(mDates){ session.from = mDates[1].trim(); session.to = mDates[2].split(/\r?\n/)[0].trim(); }
    const mDur = text.match(/\bSession:\s*([0-9]{1,2}:[0-9]{2})h/i);
    if(mDur){ session.durationHours = durToHours(mDur[1]); }

    const mLootType = text.match(/Loot Type:\s*([^\r\n]+)/i);
    if(mLootType){ session.lootType = mLootType[1].trim(); }

    const mGroupLoot = text.match(/\n\s*Loot:\s*([\d,\.]+)/);
    const mGroupSupp = text.match(/\n\s*Supplies:\s*([\d,\.]+)/);
    const mGroupBal  = text.match(/\n\s*Balance:\s*([\-\d,\.]+)/);
    if(mGroupLoot) session.group.loot = num(mGroupLoot[1]);
    if(mGroupSupp) session.group.supplies = num(mGroupSupp[1]);
    if(mGroupBal)  session.group.balance = num(mGroupBal[1]);

    const headerWords = /^(Session data:|Session:|Loot Type:|Loot:|Supplies:|Balance:|Damage:|Healing:)/i;
    let i=0; while(i<lines.length){
      const line = lines[i].trimEnd();
      const raw = lines[i];
      if(raw && !/^\s/.test(raw) && !headerWords.test(line)){
        let name = line.trim().replace(/\s*\(Leader\)\s*$/i,"");
        const displayName = name;
        const p = { key:name, displayName, loot:0,supplies:0,balance:0,damage:0,healing:0 };
        i++;
        while(i<lines.length && /^\s/.test(lines[i])){
          const sub = lines[i].trim();
          const parts = sub.split(/:\s*/);
          const k = parts[0] || "";
          const v = parts.slice(1).join(": ");
          if(/Loot/i.test(k)) p.loot = num(v);
          else if(/Supplies/i.test(k)) p.supplies = num(v);
          else if(/Balance/i.test(k)) p.balance = num(v);
          else if(/Damage/i.test(k)) p.damage = num(v);
          else if(/Healing/i.test(k)) p.healing = num(v);
          i++;
        }
        session.players.push(p);
        continue;
      }
      i++;
    }

    const sumBalances = session.players.reduce((a,b)=>a + (b.balance||0), 0);
    if(session.group.balance && Math.abs(sumBalances - session.group.balance) > 5){
      session.warnings.push("Sum of player balances ("+fmt(sumBalances)+") differs from group Balance ("+fmt(session.group.balance)+")");
    }
    return session;
  }

  function aggregate(sessions){
    const agg = new Map();
    const presenceHours = new Map();
    const byKey = (key) => {
      if(!agg.has(key)) agg.set(key, { key, displayName:key, totalBalance:0, totalLoot:0, totalSupplies:0, totalDamage:0, totalHealing:0, sessions:0 });
      return agg.get(key);
    };

    sessions.forEach(s=>{
      s.players.forEach(p=>{
        const a = byKey(p.key);
        a.displayName = p.displayName;
        a.totalBalance += p.balance||0;
        a.totalLoot += p.loot||0;
        a.totalSupplies += p.supplies||0;
        a.totalDamage += p.damage||0;
        a.totalHealing += p.healing||0;
        a.sessions += 1;
        presenceHours.set(p.key, (presenceHours.get(p.key)||0) + (s.durationHours||0));
      });
    });

    const rows = Array.from(agg.values()).map(r=>{
      const hours = presenceHours.get(r.key)||0;
      return { ...r, hours, perHour: hours>0 ? r.totalBalance / hours : 0 };
    }).sort((a,b)=> (b.totalBalance - a.totalBalance) || a.displayName.localeCompare(b.displayName));

    return { rows, presenceHours };
  }

  // Per-session equalization: only among players present in that session
  function settleSessionEqualized(players){
    const total = players.reduce((a,b)=>a + (b.balance||0), 0);
    const n = players.length || 1;
    const avg = total / n;

    const payers = [];   // above avg -> need to pay excess
    const receivers = []; // below avg -> need to receive shortage

    players.forEach(p=>{
      const diff = Math.round((p.balance||0) - avg);
      if(diff>0) payers.push({ name:p.displayName, amt: diff });
      else if(diff<0) receivers.push({ name:p.displayName, amt: -diff });
    });

    payers.sort((a,b)=>b.amt-a.amt);
    receivers.sort((a,b)=>b.amt-a.amt);

    const tx = [];
    let pi=0, ri=0;
    while(pi<payers.length && ri<receivers.length){
      const p = payers[pi];
      const r = receivers[ri];
      const pay = Math.min(p.amt, r.amt);
      if(pay>0){
        tx.push({ from:p.name, to:r.name, amount:pay });
        p.amt -= pay; r.amt -= pay;
      }
      if(p.amt<=0) pi++;
      if(r.amt<=0) ri++;
    }

    const residue = Math.round(players.reduce((a,b)=>a + Math.round((b.balance||0) - avg),0));
    return { tx, residue, avg };
  }

  // Consolidate transfers across all sessions by (from,to)
  function consolidateTransfers(allTx){
    const map = new Map(); // key "from|to" -> amount
    allTx.forEach(t=>{
      const key = t.from + "|" + t.to;
      map.set(key, (map.get(key)||0) + t.amount);
    });
    return Array.from(map.entries()).map(([key, amount])=>{
      const [from,to] = key.split("|");
      return { from, to, amount };
    }).sort((a,b)=> b.amount - a.amount);
  }

  function render(sessions, agg, perSessionTx, consolidated){
    const out = $("#output");
    out.innerHTML = "";

    // Top summary
    const totalSessions = sessions.length;
    const totalHours = sessions.reduce((a,b)=>a+(b.durationHours||0),0);
    const totalGroupBalance = sessions.reduce((a,b)=>a+(b.group.balance||0),0);
    const sumCheck = agg.rows.reduce((a,b)=>a + b.totalBalance,0);
    const warnSum = Math.abs(sumCheck - totalGroupBalance) > 5;

    const summary = document.createElement("div");
    summary.className = "card";
    summary.innerHTML = `
      <div class="row">
        <div><div class="muted">Sessions</div><div style="font-size:22px;font-weight:700">${totalSessions}</div></div>
        <div><div class="muted">Total Hours</div><div style="font-size:22px;font-weight:700">${totalHours.toFixed(2)}</div></div>
        <div><div class="muted">Group Balance (sum)</div><div style="font-size:22px;font-weight:700" class="${totalGroupBalance>=0?'good':'bad'}">${fmt(totalGroupBalance)}</div></div>
        <div><div class="muted">Net (from players)</div><div style="font-size:22px;font-weight:700" class="${warnSum?'warn':''}">${fmt(Math.round(sumCheck))}</div></div>
        <div><div class="muted">Players (unique)</div><div style="font-size:22px;font-weight:700">${agg.rows.length}</div></div>
      </div>
      ${warnSum?`<div class="spacer"></div><div class="notice">Heads up: Sum of players (${fmt(Math.round(sumCheck))}) != sum of session balances (${fmt(totalGroupBalance)}). I used player balances for settlement.</div>`:""}
    `;
    out.appendChild(summary);

    // Aggregated per person
    const per = document.createElement("div");
    per.className = "card";
    per.innerHTML = `<div class="toolbar"><strong>Aggregated ‚Äî per person</strong><span class="muted">(across all sessions)</span><span class="right small"><button id="copy-agg">Copy CSV</button></span></div>`;
    const tbl = document.createElement("table");
    tbl.innerHTML = `
      <thead><tr>
        <th>Player</th><th class="nowrap">Sessions</th><th class="nowrap">Hours</th>
        <th>Loot</th><th>Supplies</th><th>Balance</th><th>Per hour</th>
      </tr></thead>
      <tbody>
        ${agg.rows.map(r=>`
          <tr>
            <td>${escapeHtml(r.displayName)}</td>
            <td>${r.sessions}</td>
            <td>${r.hours.toFixed(2)}</td>
            <td>${fmt(r.totalLoot)}</td>
            <td>${fmt(r.totalSupplies)}</td>
            <td class="${r.totalBalance>=0?'good':'bad'}">${fmt(r.totalBalance)}</td>
            <td class="${r.perHour>=0?'good':'bad'}">${fmt(Math.round(r.perHour))}</td>
          </tr>`).join("")}
      </tbody>
    `;
    per.appendChild(tbl);
    out.appendChild(per);
    per.querySelector("#copy-agg").addEventListener("click", ()=>{
      const header = ["Player","Sessions","Hours","Loot","Supplies","Balance","PerHour"];
      const rows = agg.rows.map(r=>[r.displayName,r.sessions,r.hours.toFixed(2),r.totalLoot,r.totalSupplies,r.totalBalance,Math.round(r.perHour)]);
      copyCSV([header,...rows]);
    });

    // CONSOLIDATED settlement across all sessions (payer->receiver pairs summed)
    const set = document.createElement("div");
    set.className = "card";
    set.innerHTML = `<div class="toolbar"><strong>Final Settlement ‚Äî consolidated</strong><span class="muted">Pairs summed across sessions</span><span class="right small"><button id="copy-all-set">Copy all</button></span></div>`;
    if(consolidated.length){
      const t = document.createElement("table");
      t.innerHTML = `
        <thead><tr><th>From</th><th>To</th><th>Amount</th><th>Action</th></tr></thead>
        <tbody>
          ${consolidated.map(t=>`
            <tr>
              <td>${escapeHtml(t.from)}</td>
              <td>${escapeHtml(t.to)}</td>
              <td class="tx-amount">${fmt(t.amount)}</td>
              <td><button class="copybtn" data-to="${escapeAttr(t.to)}" data-amount="${t.amount}">Copy</button></td>
            </tr>`).join("")}
        </tbody>
      `;
      set.appendChild(t);
    }else{
      set.innerHTML += `<div class="muted">Nothing to settle ‚Äî everyone is even.</div>`;
    }
    out.appendChild(set);

    // Copy handlers
    set.querySelector("#copy-all-set")?.addEventListener("click", ()=>{
      const lines = consolidated.map(t=>`Transfer ${fmtPlain(t.amount)} to ${t.to}`);
      navigator.clipboard.writeText(lines.join("\n")).then(()=>toast("Copied all transfers")));
    });
    set.addEventListener("click", (ev)=>{
      const btn = ev.target.closest(".copybtn");
      if(!btn) return;
      const amount = btn.getAttribute("data-amount");
      const to = btn.getAttribute("data-to");
      const line = `Transfer ${fmtPlain(amount)} to ${to}`;
      navigator.clipboard.writeText(line).then(()=>toast("Copied: "+line));
    });

    // Per-session cards with their own settlement tables
    sessions.forEach(s=>{
      const d = document.createElement("div");
      d.className = "card";
      const title = `Session #${String(s.index).padStart(2,"0")} ‚Ä¢ ${s.from?escapeHtml(s.from):""} ‚Üí ${s.to?escapeHtml(s.to):""} ‚Ä¢ ${s.durationHours.toFixed(2)}h`;
      d.innerHTML = `<div class="toolbar"><strong>${title}</strong><span class="pill">Loot Type: ${escapeHtml(s.lootType||"-")}</span><span class="pill">Group Bal: <span class="${s.group.balance>=0?'good':'bad'}">${fmt(s.group.balance)}</span></span></div>`;
      if(s.warnings.length){
        d.innerHTML += s.warnings.map(w=>`<div class="spacer"></div><div class="notice">${escapeHtml(w)}</div>`).join("");
      }
      const t = document.createElement("table");
      t.innerHTML = `
        <thead><tr><th>Player</th><th>Loot</th><th>Supplies</th><th>Balance</th><th>Damage</th><th>Healing</th></tr></thead>
        <tbody>
          ${s.players.sort(by("displayName")).map(p=>`<tr>
            <td>${escapeHtml(p.displayName)}</td>
            <td>${fmt(p.loot)}</td><td>${fmt(p.supplies)}</td>
            <td class="${p.balance>=0?'good':'bad'}">${fmt(p.balance)}</td>
            <td>${fmt(p.damage)}</td><td>${fmt(p.healing)}</td>
          </tr>`).join("")}
        </tbody>`;
      d.appendChild(t);

      // Session-level settlement table
      if(s.tx && s.tx.length){
        const ts = document.createElement("div");
        ts.style.marginTop = "8px";
        ts.innerHTML = `<div class="toolbar"><strong>Session settlement</strong><span class="muted">Equalized among ${s.players.length} players</span></div>`;
        const tt = document.createElement("table");
        tt.innerHTML = `
          <thead><tr><th>From</th><th>To</th><th>Amount</th><th>Action</th></tr></thead>
          <tbody>
            ${s.tx.map(t=>`
              <tr>
                <td>${escapeHtml(t.from)}</td>
                <td>${escapeHtml(t.to)}</td>
                <td class="tx-amount">${fmt(t.amount)}</td>
                <td><button class="copybtn" data-to="${escapeAttr(t.to)}" data-amount="${t.amount}">Copy</button></td>
              </tr>`).join("")}
          </tbody>
        `;
        ts.appendChild(tt);
        d.appendChild(ts);
      }

      out.appendChild(d);
    });
  }

  function escapeHtml(s){
    return (s+"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  }
  function escapeAttr(s){
    return (s+"").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }

  function copyCSV(rows){
    const csv = rows.map(r=>r.map(v=>{
      const s = (v==null?"":String(v));
      return /[",\n]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s;
    }).join(","))
    .join("\n");
    navigator.clipboard.writeText(csv).then(()=>toast("Copied CSV!"));
  }

  function toast(msg){
    const t = document.createElement("div");
    t.textContent = msg;
    Object.assign(t.style, {position:"fixed",bottom:"16px",right:"16px",padding:"10px 12px",background:"#0d1422",border:"1px solid #284166",borderRadius:"10px",boxShadow:"0 10px 24px rgba(0,0,0,.35)",zIndex:9999});
    document.body.appendChild(t);
    setTimeout(()=>t.remove(), 1400);
  }

  function analyze(){
    const raw = $("#paste").value || "";
    if(!raw.trim()){ toast("Paste some session data first"); return; }
    const blocks = splitSessions(raw);
    if(blocks.length===0){ toast("No sessions found"); return; }
    const sessions = blocks.map((b,i)=>parseSession(b, i+1));

    // Per-session settlement and capture transfers
    const allTx = [];
    sessions.forEach(s=>{
      const res = settleSessionEqualized(s.players);
      s.tx = res.tx;
      s.settleAvg = res.avg;
      s.residue = res.residue;
      allTx.push(...res.tx);
    });

    const agg = aggregate(sessions);
    const consolidated = consolidateTransfers(allTx);

    render(sessions, agg, allTx, consolidated);

    try{ localStorage.setItem("tibia-loot-split-last", raw); }catch(e){}
  }

  $("#analyze").addEventListener("click", analyze);
  $("#clear").addEventListener("click", ()=>{
    $("#paste").value="";
    $("#output").innerHTML="";
    try{localStorage.removeItem("tibia-loot-split-last");}catch(e){}
  });

  try{
    const last = localStorage.getItem("tibia-loot-split-last");
    if(last) $("#paste").value = last;
  }catch(e){}
})();
</script>
</body>
</html>
